{% extends "shop/base.html" %}
{% block title %}{{ product.name }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
  <a href="{% url 'shop:category_detail' product.subcategory.category.slug %}">{{ product.subcategory.category.name }}</a>
</li>
<li class="breadcrumb-item">
  <a href="{% url 'shop:subcategory_detail' product.subcategory.slug %}">{{ product.subcategory.name }}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-md-6">
      <img id="product-image" src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}">
    </div>
    <div class="col-md-6">
      <h2>{{ product.name }}</h2>
      {% if product.description %}
        <p>{{ product.description }}</p>
      {% endif %}

      {% if product.has_variants %}
        <form method="POST" action="{% url 'shop:add_to_cart' product.slug %}">
          {% csrf_token %}

          {% if show_color %}
          <div class="mb-3">
            <label for="color" class="form-label">Колір</label>
            <select id="color" class="form-select" name="color">
              <option value="">Виберіть колір</option>
              {% for color in unique_colors %}
                <option value="{{ color }}">{{ color }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}

          {% if show_size %}
          <div class="mb-3">
            <label for="size" class="form-label">
              Розмір{% if product.unit_of_measurement %} ({{ product.unit_of_measurement.name }}){% endif %}
            </label>
            <select id="size" class="form-select" name="size">
              <option value="">Виберіть розмір</option>
              {% for size in unique_sizes %}
                <option value="{{ size }}">{{ size }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}

          <div id="price" class="mb-3">
            <strong>Ціна: </strong><span>{{ product.price }} грн</span>
          </div>

          <div id="stock-status" class="mb-3">
            <strong>Наявність: </strong><span>—</span>
          </div>

          <button type="submit" class="btn btn-primary" id="add-to-cart-btn" disabled>Додати до корзини</button>
        </form>

      {% else %}
        <p><strong>Ціна:</strong> {{ product.price }} грн</p>
        <p><strong>Наявність:</strong>
          {% if product.quantity > 0 %}
          <span style="color: green; font-weight: bold;">В наявності</span>
          {% else %}
          <span style="color: red; font-weight: bold;">Немає в наявності</span>
          {% endif %}
        </p>
        <form method="POST" action="{% url 'shop:add_to_cart' product.slug %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary" id="add-to-cart-btn" {% if product.quantity == 0 %} disabled {% endif %}>Додати до корзини</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>
{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const colorSelect = document.getElementById('color');
    const sizeSelect = document.getElementById('size');
    const priceDisplay = document.getElementById('price').querySelector('span');
    const stockDisplay = document.getElementById('stock-status').querySelector('span');
    const imageDisplay = document.getElementById('product-image');
    const addToCartBtn = document.getElementById('add-to-cart-btn');

    const variants = [
      {% for variant in variants %}
        {
          color: "{{ variant.color|escapejs }}",
          size: "{{ variant.size|escapejs }}",
          price: "{{ variant.price }}",
          image: "{{ variant.image.url }}",
          quantity: {{ variant.quantity }}
        },
      {% endfor %}
    ];

    function updateProductDetails() {
      const selectedColor = colorSelect ? colorSelect.value : '';
      const selectedSize = sizeSelect ? sizeSelect.value : '';

      const matchedVariant = variants.find(variant => {
        return (!selectedColor || variant.color === selectedColor) &&
               (!selectedSize || variant.size === selectedSize);
      });

      if (matchedVariant) {
        if (matchedVariant.image) {
          imageDisplay.src = matchedVariant.image;
        }
        if (matchedVariant.price) {
          priceDisplay.textContent = matchedVariant.price + ' грн';
        }

        if (matchedVariant.quantity > 0) {
          stockDisplay.textContent = 'В наявності';
          stockDisplay.style.color = 'green';
          stockDisplay.style.fontWeight = 'bold';
          addToCartBtn.disabled = false;
        } else {
          stockDisplay.textContent = 'Немає в наявності';
          stockDisplay.style.color = 'red';
          stockDisplay.style.fontWeight = 'bold';
          addToCartBtn.disabled = true;
        }
      } else {
        stockDisplay.textContent = '—';
        stockDisplay.style.color = '';
        stockDisplay.style.fontWeight = '';
        addToCartBtn.disabled = true;
      }
    }

    if (colorSelect) colorSelect.addEventListener('change', updateProductDetails);
    if (sizeSelect) sizeSelect.addEventListener('change', updateProductDetails);

    updateProductDetails();
  });
</script>
{% endblock %}
{% endblock %}
